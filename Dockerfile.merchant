FROM node:22-slim

RUN npm install -g pnpm@latest

WORKDIR /app

COPY package.json pnpm-lock.yaml ./

# Strip file: devDeps (won't resolve outside monorepo)
# Keep pnpm.patchedDependencies so @x402/core patch is applied
RUN node -e " \
  const p = JSON.parse(require('fs').readFileSync('package.json','utf8')); \
  const dev = p.devDependencies || {}; \
  for (const k of Object.keys(dev)) { \
    if (typeof dev[k] === 'string' && dev[k].startsWith('file:')) delete dev[k]; \
  } \
  require('fs').writeFileSync('package.json', JSON.stringify(p, null, 2)); \
"

# Copy patches so pnpm can apply them during install
COPY patches/ patches/

# Install all deps (devDeps have @x402/express, @x402r/helpers, etc.)
RUN pnpm install

# Copy only the merchant files
COPY src/merchant-server.ts src/
COPY src/merchant-bot.ts src/

EXPOSE 4021

# Default: merchant server. Override for bot:
#   npx tsx src/merchant-bot.ts
CMD ["npx", "tsx", "src/merchant-server.ts"]
